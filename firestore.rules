rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return signedIn() && request.auth.token.admin == true;
    }

    function isSelf(userId) {
      return signedIn() && request.auth.uid == userId;
    }

    function isCurrentSquadMember() {
      return signedIn() &&
        resource.data.memberIds is list &&
        resource.data.memberIds.hasAny([request.auth.uid]);
    }

    function isResultingSquadMember() {
      return signedIn() &&
        request.resource.data.memberIds is list &&
        request.resource.data.memberIds.hasAny([request.auth.uid]);
    }

    function currentUserSquadId() {
      return signedIn()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.squadId
        : null;
    }

    function canAccessPleaData(pleaData) {
      return signedIn() &&
        pleaData.squadId is string &&
        currentUserSquadId() == pleaData.squadId;
    }

    function isMockPlea(pleaData) {
      return pleaData.isMockSession == true;
    }

    function canReadUserDoc(userId, userData) {
      return isSelf(userId) ||
        (signedIn() &&
          userData.squadId is string &&
          currentUserSquadId() == userData.squadId);
    }

    function isValidPleaMessageCreate(messageData) {
      return messageData.keys().hasOnly([
          'senderId',
          'senderName',
          'text',
          'timestamp',
          'isSystem',
        ]) &&
        messageData.senderId is string &&
        messageData.senderId == request.auth.uid &&
        messageData.senderName is string &&
        messageData.senderName.size() > 0 &&
        messageData.senderName.size() <= 64 &&
        messageData.text is string &&
        messageData.text.size() > 0 &&
        messageData.text.size() <= 400 &&
        messageData.timestamp is timestamp &&
        (!messageData.keys().hasAny(['isSystem']) ||
          messageData.isSystem == false);
    }

    // User profiles
    match /users/{userId} {
      // Self read or same-squad read.
      allow read: if isAdmin() || canReadUserDoc(userId, resource.data);

      // Own profile management (create/update/delete account doc)
      allow create, update, delete: if isAdmin() || isSelf(userId);

      // Cloud-synced regimes live under the user's document.
      match /regimes/{regimeId} {
        allow read, write: if isAdmin() || isSelf(userId);
      }
    }

    // Squad collaboration
    match /squads/{squadId} {
      allow create, read: if isAdmin() || signedIn();

      // Allows joining/leaving/updating squad membership for authenticated users
      // and supports deleting an emptied squad during account delete/leave flow.
      allow update, delete: if isAdmin() || isCurrentSquadMember() || isResultingSquadMember();

      // Squad log (server-written audit trail)
      match /logs/{logId} {
        allow read: if isAdmin() || (signedIn() && currentUserSquadId() == squadId);
        allow create, update, delete: if false;
      }
    }

    // Plea creation/voting
    match /pleas/{pleaId} {
      // Plea documents are created/updated by Cloud Functions (Admin SDK), not by clients.
      allow create: if false;
      allow read: if isAdmin() || canAccessPleaData(resource.data) || isMockPlea(resource.data);
      allow update, delete: if false;

      // Session chat messages
      match /messages/{messageId} {
        allow read: if isAdmin() || (signedIn() &&
          (canAccessPleaData(get(/databases/$(database)/documents/pleas/$(pleaId)).data) ||
            isMockPlea(get(/databases/$(database)/documents/pleas/$(pleaId)).data)));

        // Client message writes are disabled; normal users must send via callable.
        // Admin clients may still write system messages directly if needed.
        allow create: if isAdmin();
        allow update, delete: if false;
      }
    }
    
    // Default deny all other access
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
